<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMarra Data Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e22;
            --bg-secondary: #28282e;
            --bg-tertiary: #32323a;
            --bg-chat: #0e0e10;
            --border: #2a2a30;
            --border-hover: #3a3a42;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9898;
            --text-muted: #5a5a60;
            --accent: #0e75b9;
            --accent-light: #1a8fd8;
            --accent-dim: #0a5f96;
            --accent-glow: rgba(14, 117, 185, 0.12);
            --accent-glow-strong: rgba(14, 117, 185, 0.25);
            --user-bg: #1c1c22;
            --assistant-bg: transparent;
            --code-bg: #161618;
            --success: #2ecc71;
            --error: #e74c3c;
            --shadow: 0 2px 20px rgba(0,0,0,0.4);
            --nav-width: 220px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            animation: fade-in 0.5s ease;
            background: url('/imagens/fundo01.jpg') center center / cover no-repeat fixed;
        }

        .login-box {
            width: 380px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
        }

        .login-logo {
            height: 70px;
            width: auto;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 25px rgba(14, 117, 185, 0.35));
        }

        .login-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .login-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 28px;
        }

        .login-field {
            margin-bottom: 14px;
            text-align: left;
        }

        .login-field label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-field input {
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .login-field input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .login-field input::placeholder {
            color: var(--text-muted);
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper input {
            padding-right: 44px;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            line-height: 1;
        }

        .toggle-password:hover {
            color: var(--text-primary);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .login-btn:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            margin-top: 14px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            color: var(--error);
            font-size: 13px;
            display: none;
        }

        .login-loading {
            display: none;
            margin-top: 12px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* ===== APP LAYOUT ===== */
        .app-layout {
            display: none;
            height: 100vh;
        }

        /* ===== NAV SIDEBAR (esquerda) ===== */
        .nav-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--nav-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 20;
        }

        .nav-brand {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-brand img {
            height: 32px;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(14, 117, 185, 0.3));
        }

        .nav-brand-text {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .nav-menu {
            flex: 1;
            padding: 12px 10px;
        }

        .nav-section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 8px 10px 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-glow);
            color: var(--accent-light);
            border-color: var(--accent-dim);
        }

        .nav-item-icon {
            font-size: 16px;
            width: 22px;
            text-align: center;
        }

        .nav-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .nav-user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: var(--accent-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }

        .nav-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-user-role {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-logout {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'DM Sans', sans-serif;
        }

        .nav-logout:hover {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: var(--nav-width);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .header-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .header-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: default;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .btn-icon {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        /* ===== SECTIONS ===== */
        .section {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .section.active {
            display: flex;
        }

        /* ===== CHAT SECTION ===== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Welcome screen */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            animation: fade-in 0.6s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-logo {
            height: 80px;
            width: auto;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 30px rgba(14, 117, 185, 0.35));
            animation: logo-glow 3s ease-in-out infinite;
        }

        @keyframes logo-glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(14, 117, 185, 0.25)); }
            50% { filter: drop-shadow(0 0 40px rgba(14, 117, 185, 0.45)); }
        }

        .welcome h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 420px;
            line-height: 1.5;
        }

        .suggestions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 28px;
            max-width: 560px;
            width: 100%;
        }

        .suggestion {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            line-height: 1.4;
        }

        .suggestion:hover {
            border-color: var(--accent);
            color: var(--text-primary);
            background: var(--accent-glow);
            transform: translateY(-1px);
        }

        .suggestion-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--accent-light);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestions-section-title {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 20px;
            margin-bottom: 10px;
            text-align: left;
            width: 100%;
            max-width: 560px;
        }

        .suggestions-section-title:first-child {
            margin-top: 28px;
        }

        /* Analytics */
        .analytics-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        .analytics-header {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .analytics-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .analytics-header p {
            color: var(--text-secondary);
            font-size: 13px;
            flex: 1;
        }

        .analytics-refresh {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .analytics-refresh:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .analytics-kpis {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .analytics-kpi {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .analytics-kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-light);
            font-family: 'JetBrains Mono', monospace;
        }

        .analytics-kpi-value.success { color: var(--success); }
        .analytics-kpi-value.error { color: var(--error); }

        .analytics-kpi-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
        }

        .analytics-card.analytics-full {
            margin-bottom: 16px;
        }

        .analytics-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .analytics-bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .analytics-bar-label {
            width: 120px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .analytics-bar-track {
            flex: 1;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .analytics-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease;
            min-width: 2px;
        }

        .analytics-bar-fill.positive { background: var(--success); }
        .analytics-bar-fill.negative { background: var(--error); opacity: 0.7; }
        .analytics-bar-fill.neutral { background: var(--accent); }

        .analytics-bar-value {
            width: 50px;
            text-align: right;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .analytics-problem {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .analytics-problem-q {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .analytics-problem-count {
            font-size: 11px;
            color: var(--error);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }

        .analytics-improvement {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .analytics-improvement strong {
            color: var(--accent-light);
        }

        .analytics-empty-msg {
            text-align: center;
            color: var(--text-muted);
            padding: 60px 20px;
            font-size: 14px;
        }

        .analytics-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 60px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .analytics-kpis { grid-template-columns: repeat(2, 1fr); }
            .analytics-grid { grid-template-columns: 1fr; }
        }

        /* Messages */
        .messages {
            max-width: 780px;
            margin: 0 auto;
            padding: 24px 24px 100px;
        }

        .message {
            margin-bottom: 24px;
            animation: msg-in 0.3s ease;
        }

        @keyframes msg-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar.user {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .message-avatar.assistant {
            background: linear-gradient(135deg, var(--accent-light), var(--accent-dim));
            color: #fff;
            padding: 2px;
        }

        .message-avatar.assistant img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .message-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .message-body {
            padding-left: 32px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-body p { margin-bottom: 10px; }
        .message-body p:last-child { margin-bottom: 0; }

        .message-body strong { color: var(--accent-light); font-weight: 600; }

        .message-body code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            border: 1px solid var(--border);
            color: var(--accent-light);
        }

        .message-body pre {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }

        .message-body pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .message-body ul, .message-body ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .message-body li { margin-bottom: 4px; }

        .message-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 13px;
        }

        .message-body th, .message-body td {
            padding: 8px 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .message-body th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--accent-light);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-body h1, .message-body h2, .message-body h3 {
            margin: 16px 0 8px;
            color: var(--text-primary);
        }

        .message-body h3 { font-size: 15px; }

        .message-body blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 14px;
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .sources {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
            padding-left: 32px;
        }

        .source-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        .response-meta {
            padding-left: 32px;
            margin-top: 8px;
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Feedback buttons */
        .feedback-bar {
            padding-left: 32px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feedback-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
            opacity: 0.5;
        }

        .feedback-btn:hover {
            opacity: 1;
            border-color: var(--border-hover);
            background: var(--bg-tertiary);
        }

        .feedback-btn.selected {
            opacity: 1;
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .feedback-btn.selected.positive {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.12);
        }

        .feedback-btn.selected.negative {
            border-color: var(--error);
            background: rgba(231, 76, 60, 0.12);
        }

        .feedback-btn.hidden {
            display: none;
        }

        .feedback-thanks {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-left: 4px;
        }

        .feedback-comment {
            display: none;
            padding-left: 32px;
            margin-top: 6px;
        }

        .feedback-comment.visible {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feedback-comment input {
            flex: 1;
            max-width: 300px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
        }

        .feedback-comment input:focus {
            border-color: var(--accent);
        }

        .feedback-comment button {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .feedback-comment button:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Query info collapsible */
        .query-info {
            margin-top: 12px;
            padding-left: 32px;
        }

        .query-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-dim);
            border-radius: 6px;
            color: var(--accent-light);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .query-toggle:hover {
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        .query-toggle-icon {
            transition: transform 0.2s ease;
        }

        .query-toggle.expanded .query-toggle-icon {
            transform: rotate(90deg);
        }

        .query-content {
            display: none;
            margin-top: 8px;
            padding: 12px;
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .query-content.visible {
            display: block;
        }

        .query-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 11px;
            color: var(--accent-light);
        }

        .query-stats {
            margin-top: 8px;
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .tipo-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            margin-left: 8px;
        }

        .tipo-badge.documentacao {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .tipo-badge.consulta_banco {
            background: var(--accent-glow);
            color: var(--accent-light);
            border: 1px solid var(--accent-dim);
        }

        .tipo-badge.arquivo {
            background: rgba(46, 204, 113, 0.12);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .tipo-badge.info {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .tipo-badge.conhecimento {
            background: rgba(155, 89, 182, 0.12);
            color: #bb86fc;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }

        /* Download link */
        .download-link {
            display: inline-block;
            background: var(--accent);
            color: white !important;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            margin: 8px 0;
            transition: background 0.2s, transform 0.1s;
        }

        .download-link:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .message-body a:not(.download-link) {
            color: var(--accent-light);
            text-decoration: underline;
        }

        /* Column toggle chips */
        .column-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 0 4px 32px;
        }
        .column-toggles .label {
            font-size: 11px;
            color: var(--text-muted);
            align-self: center;
            margin-right: 2px;
        }
        .col-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.15s;
            user-select: none;
        }
        .col-chip:hover { border-color: var(--accent-dim); }
        .col-chip.active {
            background: var(--accent-glow);
            color: var(--accent-light);
            border-color: var(--accent-dim);
        }

        /* Thinking indicator */
        .thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 32px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent-light);
            border-radius: 50%;
            animation: dot-bounce 1.2s ease-in-out infinite;
        }

        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dot-bounce {
            0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1.1); }
        }

        /* ===== INPUT AREA ===== */
        .input-area {
            padding: 16px 24px 20px;
            background: linear-gradient(to top, var(--bg-primary) 70%, transparent);
            flex-shrink: 0;
        }

        .input-wrapper {
            max-width: 780px;
            margin: 0 auto;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            transition: border-color 0.2s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #chat-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            padding: 10px 14px;
            resize: none;
            max-height: 150px;
            min-height: 22px;
            line-height: 1.5;
        }

        #chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
            font-size: 16px;
        }

        .send-btn:hover {
            background: var(--accent-light);
            transform: scale(1.04);
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== REPORTS SECTION ===== */
        .reports-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .reports-header {
            margin-bottom: 28px;
        }

        .reports-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .reports-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .report-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
            cursor: default;
        }

        .report-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .report-card-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .report-card h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .report-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .report-card-badge {
            display: inline-block;
            margin-top: 12px;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-soon {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .badge-ready {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        /* ===== REPORT VIEW ===== */
        .report-view { display: none; }
        .report-view.active { display: block; }

        .report-view-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .report-back-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }
        .report-back-btn:hover { border-color: var(--accent); color: var(--accent-light); }

        .report-view-title {
            font-size: 20px;
            font-weight: 700;
            flex: 1;
        }

        .report-export-btn {
            background: var(--accent-dim);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }
        .report-export-btn:hover { background: var(--accent); }

        .report-filters {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .report-filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .report-filter-group label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-filter-group input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            width: 150px;
        }
        .report-filter-group input:focus { outline: none; border-color: var(--accent); }

        .report-filter-apply {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            transition: all 0.15s;
        }
        .report-filter-apply:hover { background: var(--accent-light); }

        .report-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .report-kpi-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            text-align: center;
        }
        .report-kpi-card.alert { border-color: rgba(231, 76, 60, 0.4); }

        .report-kpi-icon { font-size: 22px; margin-bottom: 6px; }

        .report-kpi-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .report-kpi-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            min-height: 300px;
        }

        .report-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .report-table-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .report-table-scroll {
            overflow-x: auto;
            max-height: 450px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .report-table th {
            background: var(--bg-tertiary);
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .report-table td {
            padding: 9px 14px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .report-table tr:hover td {
            background: rgba(14, 117, 185, 0.05);
        }

        .report-table .currency {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .report-table .number {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            gap: 12px;
        }

        .report-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .report-time {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== CROSS-FILTER ===== */
        .cross-filter-bar {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            padding: 10px 16px;
            background: var(--accent-glow);
            border: 1px solid rgba(14, 117, 185, 0.3);
            border-radius: 8px;
            font-size: 13px;
            animation: fade-in 0.2s ease;
        }
        .cross-filter-bar.active { display: flex; }
        .cross-filter-bar .cf-icon { font-size: 15px; }
        .cross-filter-bar .cf-label { color: var(--text-secondary); }
        .cross-filter-bar .cf-value { color: var(--accent-light); font-weight: 600; }
        .cross-filter-bar .cf-clear {
            margin-left: auto;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
        }
        .cross-filter-bar .cf-clear:hover {
            border-color: var(--error);
            color: var(--error);
        }
        .report-cache-badge {
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--success);
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.25);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .report-active-filter {
            display: none;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 10px 16px;
            background: var(--accent-glow);
            border: 1px solid rgba(14, 117, 185, 0.3);
            border-radius: 8px;
            font-size: 13px;
            animation: fade-in 0.2s ease;
        }

        .report-active-filter.active {
            display: flex;
        }

        .report-active-filter .filter-label {
            color: var(--accent-light);
            font-weight: 600;
        }

        .report-active-filter .filter-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
            padding: 2px 10px;
            border-radius: 4px;
        }

        .report-active-filter .filter-clear {
            margin-left: auto;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
        }

        .report-active-filter .filter-clear:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .report-cache-badge {
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.25);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 4px;
        }

        /* Categoria tabs (6 abas como Power BI) */
        .report-categorias {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            overflow-x: auto;
            border-bottom: 2px solid var(--border);
        }

        .report-cat-tab {
            flex: 1;
            min-width: 140px;
            padding: 14px 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            background: transparent;
        }

        .report-cat-tab:hover {
            background: var(--bg-secondary);
        }

        .report-cat-tab.active {
            border-bottom-color: var(--accent);
            background: var(--accent-glow);
        }

        .report-cat-tab .cat-nome {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .report-cat-tab.active .cat-nome {
            color: var(--accent-light);
        }

        .report-cat-tab .cat-valor {
            font-size: 16px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .report-cat-tab .cat-detalhe {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Dropdown filters */
        .report-filter-group select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            width: 160px;
            cursor: pointer;
        }

        .report-filter-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Multi-chart grid (2x2 como Power BI) */
        .report-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
            animation: slide-up 0.4s ease 0.15s both;
        }

        .report-chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            min-height: 220px;
        }

        .report-chart-card .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Horizontal bar chart */
        .hbar-chart {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .hbar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 2px 0;
            transition: opacity 0.15s;
        }

        .hbar-row:hover { opacity: 0.85; }

        .hbar-row.dimmed { opacity: 0.3; }

        .hbar-label {
            font-size: 11px;
            color: var(--text-secondary);
            width: 110px;
            min-width: 110px;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .hbar-bar-container {
            flex: 1;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .hbar-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .hbar-value {
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            min-width: 80px;
            text-align: right;
        }

        /* ===== INFO SIDEBAR (direita) ===== */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -340px;
            width: 340px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 100;
            transition: right 0.25s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar.active { right: 0; }

        .sidebar h3 {
            font-size: 14px;
            margin-bottom: 16px;
            color: var(--accent-light);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .cat-list {
            list-style: none;
        }

        .cat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .cat-item:last-child { border-bottom: none; }

        .cat-count {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-light);
            font-weight: 600;
        }

        /* ===== MOBILE NAV ===== */
        .mobile-nav-toggle {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 25;
            width: 38px;
            height: 38px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .nav-sidebar {
                left: -260px;
                width: 260px;
                transition: left 0.25s ease;
            }
            .nav-sidebar.mobile-open {
                left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-nav-toggle {
                display: flex;
            }
            .suggestions { grid-template-columns: 1fr; }
            .header { padding: 10px 16px 10px 56px; }
            .messages { padding: 16px 16px 100px; }
            .input-area { padding: 12px 16px 16px; }
            .status-badge { display: none; }
            .reports-container { padding: 20px 16px; }
        }
    </style>
</head>
<body>

    <!-- ===== LOGIN SCREEN ===== -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <img src="imagens/logo.png" class="login-logo" alt="MMarra">
            <div class="login-title">Data Hub</div>
            <div class="login-subtitle">Entre com suas credenciais do Sankhya</div>

            <div class="login-field">
                <label>Usuario</label>
                <input type="text" id="login-user" placeholder="Seu usuario Sankhya" autocomplete="username" autofocus>
            </div>
            <div class="login-field">
                <label>Senha</label>
                <div class="password-wrapper">
                    <input type="password" id="login-pass" placeholder="Sua senha" autocomplete="current-password">
                    <button type="button" class="toggle-password" onclick="togglePassword()" title="Mostrar/ocultar senha"><svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>

            <button class="login-btn" id="login-btn" onclick="doLogin()">Entrar</button>

            <div class="login-loading" id="login-loading">Autenticando...</div>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <!-- ===== APP LAYOUT ===== -->
    <div class="app-layout" id="app-layout">

        <!-- Mobile nav toggle -->
        <button class="mobile-nav-toggle" id="mobile-nav-toggle" onclick="toggleMobileNav()">&#9776;</button>

        <!-- NAV SIDEBAR (esquerda) -->
        <div class="nav-sidebar" id="nav-sidebar">
            <div class="nav-brand">
                <img src="imagens/logo.png" alt="MMarra">
                <span class="nav-brand-text">Data Hub</span>
            </div>

            <div class="nav-menu">
                <div class="nav-section-label">Menu</div>
                <div class="nav-item active" data-section="chat" onclick="switchSection('chat')">
                    <span class="nav-item-icon">&#128172;</span>
                    <span>Chat IA</span>
                </div>
                <div class="nav-item" data-section="reports" onclick="switchSection('reports')">
                    <span class="nav-item-icon">&#128202;</span>
                    <span>Relatorios</span>
                </div>
                <div class="nav-item admin-only" data-section="analytics" onclick="switchSection('analytics')" id="nav-analytics" style="display:none;">
                    <span class="nav-item-icon">&#128200;</span>
                    <span>Analytics</span>
                </div>
            </div>

            <div class="nav-footer">
                <div class="nav-user">
                    <div class="nav-user-avatar" id="nav-avatar">U</div>
                    <div>
                        <div class="nav-user-name" id="nav-username">Usuario</div>
                        <div class="nav-user-role" id="nav-user-role">Sankhya</div>
                    </div>
                </div>
                <button class="nav-logout" onclick="doLogout()">
                    <span>&#10140;</span> Sair
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">

            <!-- HEADER -->
            <div class="header">
                <div class="header-left">
                    <div>
                        <div class="header-title" id="section-title">Chat IA</div>
                        <div class="header-subtitle" id="model-info">carregando...</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-badge">
                        <span class="status-dot"></span>
                        <span id="doc-count">--</span> docs
                    </div>
                    <button class="btn-icon" onclick="toggleSidebar()" title="Status">&#9776;</button>
                    <button class="btn-icon" onclick="clearChat()" title="Limpar conversa">&#128465;</button>
                </div>
            </div>

            <!-- CHAT SECTION -->
            <div class="section active" id="section-chat">
                <div class="chat-container" id="chat-container">
                    <div class="welcome" id="welcome">
                        <img src="imagens/logo.png" class="welcome-logo" alt="MMarra">
                        <h2>Data Hub</h2>
                        <p>Assistente inteligente sobre os dados, processos e regras de negocio da MMarra Distribuidora Automotiva.</p>
                        <!-- Sugestoes dinamicas (carregadas da API) -->
                        <div id="dynamic-suggestions"></div>
                        <!-- Sugestoes estaticas (fallback) -->
                        <div class="suggestions" id="static-suggestions">
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Processo</div>
                                Como funciona o fluxo de compras?
                            </div>
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Regra</div>
                                A MMarra usa workflow de aprovacao?
                            </div>
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Query</div>
                                Query para ver compras do mes por fornecedor
                            </div>
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Tabela</div>
                                Quais campos da TGFCAB controlam o status?
                            </div>
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Dados</div>
                                Quais sao os maiores fornecedores da MMarra?
                            </div>
                            <div class="suggestion" onclick="askSuggestion(this)">
                                <div class="suggestion-label">Tecnico</div>
                                Como funciona a cotacao de compra?
                            </div>
                        </div>
                    </div>
                    <div class="messages" id="messages" style="display:none;"></div>
                </div>

                <!-- INPUT -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea id="chat-input"
                            placeholder="Pergunte sobre dados, processos ou regras da MMarra..."
                            rows="1"
                            onkeydown="handleKey(event)"
                            oninput="autoResize(this)"></textarea>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>&#10148;</button>
                    </div>
                </div>
            </div>

            <!-- REPORTS SECTION -->
            <div class="section" id="section-reports">
                <div class="reports-container">
                    <!-- GRID DE CARDS (lista de relatorios) -->
                    <div id="reports-list">
                        <div class="reports-header">
                            <h2>Relatorios</h2>
                            <p>Acesse os relatorios de compras, vendas e estoque da MMarra.</p>
                        </div>
                        <div class="reports-grid">
                            <div class="report-card" data-module="compras" data-report-id="pendencia_compras" onclick="openReport('pendencia_compras')" style="cursor:pointer;">
                                <div class="report-card-icon">&#128230;</div>
                                <h3>Pendencia de Compras</h3>
                                <p>Itens pendentes de entrega por fornecedor, marca e comprador. Status de atraso e previsao.</p>
                                <span class="report-card-badge badge-ready">Disponivel</span>
                            </div>
                            <div class="report-card" data-module="compras">
                                <div class="report-card-icon">&#128200;</div>
                                <h3>Historico por Fornecedor</h3>
                                <p>Pedidos e notas de entrada dos ultimos meses. Valores pedidos, atendidos e pendentes.</p>
                                <span class="report-card-badge badge-soon">Em breve</span>
                            </div>
                            <div class="report-card" data-module="compras">
                                <div class="report-card-icon">&#127942;</div>
                                <h3>Performance Fornecedores</h3>
                                <p>Ranking de atrasos, pontualidade e media de dias em aberto por fornecedor.</p>
                                <span class="report-card-badge badge-soon">Em breve</span>
                            </div>
                            <div class="report-card" data-module="vendas" data-report-id="vendas_periodo" onclick="openReport('vendas_periodo')" style="cursor:pointer;">
                                <div class="report-card-icon">&#128722;</div>
                                <h3>Vendas por Periodo</h3>
                                <p>Faturamento, ticket medio e top produtos vendidos por periodo.</p>
                                <span class="report-card-badge badge-ready">Disponivel</span>
                            </div>
                            <div class="report-card" data-module="vendas" data-report-id="estoque_critico" onclick="openReport('estoque_critico')" style="cursor:pointer;">
                                <div class="report-card-icon">&#128451;</div>
                                <h3>Estoque Critico</h3>
                                <p>Produtos abaixo do estoque minimo e sugestao de reposicao.</p>
                                <span class="report-card-badge badge-ready">Disponivel</span>
                            </div>
                            <div class="report-card" data-module="vendas">
                                <div class="report-card-icon">&#128203;</div>
                                <h3>Curva ABC</h3>
                                <p>Classificacao ABC de produtos por faturamento e volume de vendas.</p>
                                <span class="report-card-badge badge-soon">Em breve</span>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW DO RELATORIO (aparece quando clica num card) -->
                    <div id="report-view" class="report-view">
                        <div class="report-view-header">
                            <button class="report-back-btn" onclick="closeReport()">&#8592; Voltar</button>
                            <span class="report-view-title" id="report-view-title">Relatorio</span>
                            <span class="report-time" id="report-time"></span>
                            <button class="report-export-btn" onclick="exportReportCSV()">&#128229; Exportar CSV</button>
                        </div>

                        <!-- Filtros expandidos (dropdowns dinamicos) -->
                        <div class="report-filters" id="report-filters">
                            <div class="report-filter-group">
                                <label>Empresa</label>
                                <select id="filter-empresa"><option value="">Todos</option></select>
                            </div>
                            <div class="report-filter-group">
                                <label>Comprador</label>
                                <select id="filter-comprador"><option value="">Todos</option></select>
                            </div>
                            <div class="report-filter-group">
                                <label>Marca</label>
                                <select id="filter-marca"><option value="">Todos</option></select>
                            </div>
                            <div class="report-filter-group">
                                <label>Data Inicio</label>
                                <input type="date" id="filter-data-ini">
                            </div>
                            <div class="report-filter-group">
                                <label>Data Fim</label>
                                <input type="date" id="filter-data-fim">
                            </div>
                            <button class="report-filter-apply" onclick="applyReportFilters()">Aplicar</button>
                        </div>

                        <div id="report-loading" class="report-loading" style="display:none;">
                            <div class="report-loading-spinner"></div>
                            <span>Carregando relatorio...</span>
                        </div>

                        <div id="report-content" style="display:none;">
                            <!-- 6 Abas de categoria (Aberto, Atrasados, 15dias...) -->
                            <div class="report-categorias" id="report-categorias"></div>

                            <!-- KPIs -->
                            <div class="report-kpis" id="report-kpis"></div>

                            <!-- Cross-filter indicator -->
                            <div class="report-active-filter" id="report-cross-filter">
                                <span class="filter-label">Filtro:</span>
                                <span class="filter-value" id="cross-filter-value"></span>
                                <button class="filter-clear" onclick="clearCrossFilter()">&#10005; Limpar filtro</button>
                            </div>

                            <!-- Tabela detalhada -->
                            <div class="report-table-container">
                                <div class="report-table-info">
                                    <span id="report-row-count">0 registros</span>
                                </div>
                                <div class="report-table-scroll">
                                    <table class="report-table" id="report-table">
                                        <thead id="report-table-head"></thead>
                                        <tbody id="report-table-body"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 4 Graficos horizontais (grid 2x2) -->
                            <div class="report-charts-grid" id="report-charts-grid"></div>

                            <!-- Grafico single (compatibilidade com vendas/estoque) -->
                            <div class="report-chart-container" id="report-chart" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS SECTION (admin only) -->
            <div class="section" id="section-analytics">
                <div class="analytics-container">
                    <div class="analytics-header">
                        <h2>&#128200; Analytics</h2>
                        <p>Metricas de uso do assistente nos ultimos 30 dias</p>
                        <button class="analytics-refresh" onclick="loadAnalytics()">&#8635; Atualizar</button>
                    </div>

                    <div id="analytics-loading" class="analytics-loading" style="display:none;">
                        <div class="report-loading-spinner"></div>
                        <span>Carregando analytics...</span>
                    </div>

                    <div id="analytics-content" style="display:none;">
                        <!-- KPIs -->
                        <div class="analytics-kpis" id="analytics-kpis"></div>

                        <!-- Grid 2 colunas: By Intent + By Layer -->
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h3>Por Intent</h3>
                                <div id="analytics-by-intent"></div>
                            </div>
                            <div class="analytics-card">
                                <h3>Por Layer</h3>
                                <div id="analytics-by-layer"></div>
                            </div>
                        </div>

                        <!-- Problem queries -->
                        <div class="analytics-card analytics-full">
                            <h3>&#9888; Perguntas com problema</h3>
                            <div id="analytics-problems"></div>
                        </div>

                        <!-- Improvement suggestions -->
                        <div class="analytics-card analytics-full">
                            <h3>&#128161; Sugestoes de melhoria</h3>
                            <div id="analytics-improvements"></div>
                        </div>
                    </div>

                    <div id="analytics-empty" style="display:none;">
                        <p class="analytics-empty-msg">Nenhum dado de analytics disponivel ainda. As metricas aparecerao conforme os usuarios usarem o chat.</p>
                    </div>
                </div>
            </div>

        </div><!-- /main-content -->
    </div><!-- /app-layout -->

    <!-- INFO SIDEBAR (direita) -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <h3>Status da Base</h3>
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-docs">--</div>
                <div class="stat-label">Documentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-tokens">--</div>
                <div class="stat-label">Tokens (aprox)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-history">0</div>
                <div class="stat-label">Mensagens</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-model">--</div>
                <div class="stat-label">Modelo</div>
            </div>
        </div>
        <h3>Categorias</h3>
        <ul class="cat-list" id="cat-list"></ul>
    </div>

    <script>
        // ===== AUTH STATE =====
        let authToken = localStorage.getItem('datahub_token');
        let currentUser = localStorage.getItem('datahub_user');
        let userRole = localStorage.getItem('datahub_role') || 'vendedor';
        let userModules = JSON.parse(localStorage.getItem('datahub_modules') || '{}');

        // ===== ELEMENTS =====
        const loginScreen = document.getElementById('login-screen');
        const appLayout = document.getElementById('app-layout');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const loginLoading = document.getElementById('login-loading');

        // ===== AUTH HELPERS =====
        function authHeaders() {
            return { 'Authorization': 'Bearer ' + authToken };
        }

        // ===== TOGGLE PASSWORD =====
        function togglePassword() {
            var input = document.getElementById('login-pass');
            var btn = document.querySelector('.toggle-password');
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
                btn.title = 'Ocultar senha';
            } else {
                input.type = 'password';
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
                btn.title = 'Mostrar senha';
            }
        }

        // ===== LOGIN =====
        async function doLogin() {
            const username = document.getElementById('login-user').value.trim();
            const password = document.getElementById('login-pass').value;

            if (!username || !password) {
                showLoginError('Preencha usuario e senha.');
                return;
            }

            loginBtn.disabled = true;
            loginError.style.display = 'none';
            loginLoading.style.display = 'block';

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Erro ao autenticar');
                }

                const data = await res.json();
                authToken = data.token;
                currentUser = data.user;
                userRole = data.role || 'vendedor';
                userModules = data.modules || {};
                localStorage.setItem('datahub_token', authToken);
                localStorage.setItem('datahub_user', currentUser);
                localStorage.setItem('datahub_role', userRole);
                localStorage.setItem('datahub_modules', JSON.stringify(userModules));

                showApp();
            } catch (e) {
                showLoginError(e.message);
            } finally {
                loginBtn.disabled = false;
                loginLoading.style.display = 'none';
            }
        }

        function showLoginError(msg) {
            loginError.textContent = msg;
            loginError.style.display = 'block';
        }

        // ===== LOGOUT =====
        async function doLogout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: authHeaders()
                });
            } catch {}

            localStorage.removeItem('datahub_token');
            localStorage.removeItem('datahub_user');
            localStorage.removeItem('datahub_role');
            localStorage.removeItem('datahub_modules');
            authToken = null;
            currentUser = null;
            userRole = 'vendedor';
            userModules = {};

            appLayout.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            document.getElementById('login-user').focus();
        }

        // ===== SHOW APP =====
        var roleLabels = {vendedor: 'Vendedor', comprador: 'Comprador', gerente: 'Gerente', admin: 'Administrador'};

        function showApp() {
            loginScreen.style.display = 'none';
            appLayout.style.display = 'block';

            // Update user info in sidebar
            document.getElementById('nav-username').textContent = currentUser;
            document.getElementById('nav-avatar').textContent = currentUser.charAt(0).toUpperCase();
            document.getElementById('nav-user-role').textContent = roleLabels[userRole] || 'Sankhya';

            // Filtrar report cards por perfil
            filterReportCards();

            // Mostrar Analytics para admin
            const navAnalytics = document.getElementById('nav-analytics');
            if (navAnalytics) {
                navAnalytics.style.display = (userRole === 'admin') ? '' : 'none';
            }

            init();
        }

        function filterReportCards() {
            var cards = document.querySelectorAll('.report-card');
            cards.forEach(function(card) {
                var mod = card.getAttribute('data-module');
                if (!mod) return;
                if (mod === 'compras' && userModules.reports_compras === false) {
                    card.style.display = 'none';
                } else if (mod === 'vendas' && userModules.reports_vendas === false) {
                    card.style.display = 'none';
                } else {
                    card.style.display = '';
                }
            });
        }

        // ===== CHECK SESSION =====
        async function checkSession() {
            if (!authToken) {
                loginScreen.style.display = 'flex';
                appLayout.style.display = 'none';
                return;
            }

            try {
                const res = await fetch('/api/me', { headers: authHeaders() });
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    userRole = data.role || 'vendedor';
                    userModules = data.modules || {};
                    localStorage.setItem('datahub_user', currentUser);
                    localStorage.setItem('datahub_role', userRole);
                    localStorage.setItem('datahub_modules', JSON.stringify(userModules));
                    showApp();
                } else {
                    localStorage.removeItem('datahub_token');
                    localStorage.removeItem('datahub_user');
                    authToken = null;
                    loginScreen.style.display = 'flex';
                    appLayout.style.display = 'none';
                }
            } catch {
                // Server offline - show login
                loginScreen.style.display = 'flex';
                appLayout.style.display = 'none';
            }
        }

        // ===== NAVIGATION =====
        function switchSection(section) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // Update sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById('section-' + section).classList.add('active');

            // Update header title
            const titles = { chat: 'Chat IA', reports: 'Relatorios', analytics: 'Analytics' };
            document.getElementById('section-title').textContent = titles[section] || section;

            // Carregar analytics ao abrir a aba
            if (section === 'analytics') loadAnalytics();

            // Close mobile nav
            document.getElementById('nav-sidebar').classList.remove('mobile-open');
        }

        function toggleMobileNav() {
            document.getElementById('nav-sidebar').classList.toggle('mobile-open');
        }

        // ===== LOGIN ENTER KEY =====
        document.getElementById('login-user').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') document.getElementById('login-pass').focus();
        });
        document.getElementById('login-pass').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') doLogin();
        });

        // ===== CHAT STATE =====
        let isLoading = false;
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const messagesEl = document.getElementById('messages');
        const welcomeEl = document.getElementById('welcome');
        const chatContainer = document.getElementById('chat-container');

        // ===== INIT =====
        async function init() {
            try {
                const res = await fetch('/api/status', { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();
                document.getElementById('doc-count').textContent = data.documents;
                document.getElementById('model-info').textContent = data.model;
                document.getElementById('stat-docs').textContent = data.documents;
                document.getElementById('stat-tokens').textContent = (data.tokens_approx / 1000).toFixed(1) + 'k';
                document.getElementById('stat-model').textContent = data.model.split('/')[1] || data.model;

                const catList = document.getElementById('cat-list');
                catList.innerHTML = '';
                const emojis = { tabela: '&#128203;', processo: '&#128260;', regra: '&#9878;', query: '&#128270;', api: '&#128268;', glossario: '&#128214;', erro: '&#10060;' };
                for (const [cat, count] of Object.entries(data.categories)) {
                    const li = document.createElement('li');
                    li.className = 'cat-item';
                    li.innerHTML = '<span>' + (emojis[cat] || '&#128196;') + ' ' + cat + '</span><span class="cat-count">' + count + '</span>';
                    catList.appendChild(li);
                }
            } catch (e) {
                document.getElementById('model-info').textContent = 'erro ao conectar';
            }

            // Carregar sugestoes dinamicas (nao bloqueia)
            loadSuggestions();
        }

        // ===== INPUT =====
        input.addEventListener('input', () => {
            sendBtn.disabled = !input.value.trim();
        });

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 150) + 'px';
        }

        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (input.value.trim()) sendMessage();
            }
        }

        // ===== SUGGESTIONS =====
        function askSuggestion(el) {
            const labelEl = el.querySelector('.suggestion-label');
            const text = labelEl ? el.textContent.replace(labelEl.textContent, '').trim() : el.textContent.trim();
            input.value = text;
            sendBtn.disabled = false;
            sendMessage();
        }

        function askDynSuggestion(text) {
            input.value = text;
            sendBtn.disabled = false;
            sendMessage();
        }

        async function loadSuggestions() {
            try {
                const res = await fetch('/api/suggestions', { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();

                const popular = data.popular || [];
                const personalized = data.personalized || [];
                const recent = data.recent_successful || [];

                // Se nao tem sugestoes dinamicas, manter estaticas
                if (popular.length === 0 && personalized.length === 0 && recent.length === 0) return;

                const container = document.getElementById('dynamic-suggestions');
                const staticEl = document.getElementById('static-suggestions');
                if (!container) return;

                let html = '';

                // Personalizadas primeiro (se houver)
                if (personalized.length > 0) {
                    html += '<div class="suggestions-section-title">&#128161; Para voce</div>';
                    html += '<div class="suggestions">';
                    personalized.forEach(function(q) {
                        html += '<div class="suggestion" onclick="askDynSuggestion(\'' + escapeAttr(q) + '\')">';
                        html += '<div class="suggestion-label">Seu perfil</div>';
                        html += escapeHtml(q);
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Populares
                if (popular.length > 0) {
                    html += '<div class="suggestions-section-title">&#128293; Populares</div>';
                    html += '<div class="suggestions">';
                    popular.slice(0, 6).forEach(function(q) {
                        html += '<div class="suggestion" onclick="askDynSuggestion(\'' + escapeAttr(q) + '\')">';
                        html += '<div class="suggestion-label">Popular</div>';
                        html += escapeHtml(q);
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Recentes com sucesso
                if (recent.length > 0) {
                    html += '<div class="suggestions-section-title">&#9989; Recentes que funcionaram</div>';
                    html += '<div class="suggestions">';
                    recent.slice(0, 4).forEach(function(q) {
                        html += '<div class="suggestion" onclick="askDynSuggestion(\'' + escapeAttr(q) + '\')">';
                        html += '<div class="suggestion-label">Recente</div>';
                        html += escapeHtml(q);
                        html += '</div>';
                    });
                    html += '</div>';
                }

                container.innerHTML = html;
                // Esconder sugestoes estaticas quando dinamicas estao disponiveis
                if (staticEl) staticEl.style.display = 'none';

            } catch (e) {
                // Falha silenciosa - manter sugestoes estaticas
                console.log('Sugestoes dinamicas indisponiveis:', e);
            }
        }

        function escapeAttr(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        // ===== ANALYTICS (admin) =====
        let analyticsLoaded = false;

        async function loadAnalytics() {
            if (userRole !== 'admin') return;

            const loadingEl = document.getElementById('analytics-loading');
            const contentEl = document.getElementById('analytics-content');
            const emptyEl = document.getElementById('analytics-empty');

            loadingEl.style.display = 'flex';
            contentEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const res = await fetch('/api/analytics', { headers: authHeaders() });
                if (!res.ok) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                const data = await res.json();
                loadingEl.style.display = 'none';

                if (data.total_queries === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                contentEl.style.display = 'block';
                renderAnalytics(data);
                analyticsLoaded = true;

            } catch (e) {
                console.error('Erro ao carregar analytics:', e);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        function renderAnalytics(data) {
            // KPIs
            const fb = data.feedback_summary || {};
            const kpisEl = document.getElementById('analytics-kpis');
            kpisEl.innerHTML =
                '<div class="analytics-kpi">' +
                    '<div class="analytics-kpi-value">' + fmtNum(data.total_queries) + '</div>' +
                    '<div class="analytics-kpi-label">Total de perguntas</div>' +
                '</div>' +
                '<div class="analytics-kpi">' +
                    '<div class="analytics-kpi-value success">' + fmtNum(fb.positive || 0) + '</div>' +
                    '<div class="analytics-kpi-label">Feedback positivo</div>' +
                '</div>' +
                '<div class="analytics-kpi">' +
                    '<div class="analytics-kpi-value error">' + fmtNum(fb.negative || 0) + '</div>' +
                    '<div class="analytics-kpi-label">Feedback negativo</div>' +
                '</div>' +
                '<div class="analytics-kpi">' +
                    '<div class="analytics-kpi-value' + (fb.satisfaction_rate >= 80 ? ' success' : fb.satisfaction_rate >= 50 ? '' : ' error') + '">' + (fb.satisfaction_rate || 0).toFixed(1) + '%</div>' +
                    '<div class="analytics-kpi-label">Satisfacao</div>' +
                '</div>';

            // By Intent
            renderBarChart('analytics-by-intent', data.by_intent || {}, data.total_queries);

            // By Layer
            renderBarChart('analytics-by-layer', data.by_layer || {}, data.total_queries);

            // Problem queries
            renderProblems(data.problem_queries || []);

            // Improvement suggestions
            renderImprovements(data.improvement_suggestions || []);
        }

        function renderBarChart(containerId, byData, total) {
            const el = document.getElementById(containerId);
            if (!el) return;
            const entries = Object.entries(byData).sort(function(a, b) { return b[1].total - a[1].total; });

            if (entries.length === 0) {
                el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Sem dados</div>';
                return;
            }

            const maxVal = Math.max(...entries.map(function(e) { return e[1].total; }));
            let html = '';

            entries.forEach(function(entry) {
                const name = entry[0];
                const stats = entry[1];
                const pct = maxVal > 0 ? (stats.total / maxVal * 100) : 0;
                const posPct = stats.total > 0 ? (stats.positive / stats.total * 100) : 0;
                const negPct = stats.total > 0 ? (stats.negative / stats.total * 100) : 0;

                html += '<div class="analytics-bar-row">' +
                    '<div class="analytics-bar-label" title="' + escapeHtml(name) + '">' + escapeHtml(name) + '</div>' +
                    '<div class="analytics-bar-track">' +
                        '<div class="analytics-bar-fill positive" style="width:' + posPct + '%;position:absolute;z-index:2;"></div>' +
                        '<div class="analytics-bar-fill neutral" style="width:' + pct + '%;"></div>' +
                    '</div>' +
                    '<div class="analytics-bar-value">' + stats.total + '</div>' +
                '</div>';
            });

            el.innerHTML = html;
        }

        function renderProblems(problems) {
            const el = document.getElementById('analytics-problems');
            if (!el) return;
            if (problems.length === 0) {
                el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Nenhuma pergunta com feedback negativo</div>';
                return;
            }
            let html = '';
            problems.forEach(function(p) {
                html += '<div class="analytics-problem">' +
                    '<div class="analytics-problem-q">"' + escapeHtml(p.question || '?') + '"</div>' +
                    '<div class="analytics-problem-count">&#128078; ' + p.negative + 'x</div>' +
                '</div>';
            });
            el.innerHTML = html;
        }

        function renderImprovements(suggestions) {
            const el = document.getElementById('analytics-improvements');
            if (!el) return;
            if (suggestions.length === 0) {
                el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Nenhuma sugestao automatica no momento</div>';
                return;
            }
            let html = '';
            suggestions.forEach(function(s) {
                if (s.type === 'groq_correction_frequent') {
                    html += '<div class="analytics-improvement"><strong>Correcao frequente:</strong> ' + escapeHtml(s.field || '') + ' (' + s.count + 'x) - considere ajustar o prompt do Groq</div>';
                } else if (s.type === 'unrecognized_pattern') {
                    html += '<div class="analytics-improvement"><strong>Padrao nao reconhecido:</strong> "' + escapeHtml(s.question || '') + '" (' + s.count + 'x) - considere adicionar novo intent ou keywords</div>';
                } else if (s.type === 'scoring_gap') {
                    html += '<div class="analytics-improvement"><strong>Scoring gap:</strong> intent <strong>' + escapeHtml(s.intent || '') + '</strong> resolvido via LLM ' + s.llm_calls + 'x - ' + escapeHtml(s.suggestion || '') + '</div>';
                } else {
                    html += '<div class="analytics-improvement">' + escapeHtml(JSON.stringify(s)) + '</div>';
                }
            });
            el.innerHTML = html;
        }

        function fmtNum(n) {
            if (n === null || n === undefined) return '0';
            return Number(n).toLocaleString('pt-BR');
        }

        // ===== SEND MESSAGE =====
        async function sendMessage() {
            const text = input.value.trim();
            if (!text || isLoading) return;

            isLoading = true;
            sendBtn.disabled = true;
            input.value = '';
            input.style.height = 'auto';

            welcomeEl.style.display = 'none';
            messagesEl.style.display = 'block';

            addMessage('user', text);
            const thinkingId = addThinking();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify({ message: text, mode: 'agent' }),
                });

                if (res.status === 401) {
                    removeThinking(thinkingId);
                    doLogout();
                    return;
                }

                const data = await res.json();
                removeThinking(thinkingId);
                addMessage('assistant', data.response, data.sources, data.time_ms, data.tipo, data.query_executed, data.query_results, data.message_id, data.table_data);

                const statHistory = document.getElementById('stat-history');
                statHistory.textContent = parseInt(statHistory.textContent || 0) + 1;
            } catch (e) {
                removeThinking(thinkingId);
                addMessage('assistant', '[X] Erro ao conectar com o servidor. Verifique se a API esta rodando.', [], 0);
            }

            isLoading = false;
            sendBtn.disabled = false;
            input.focus();
        }

        // ===== MESSAGES =====
        function addMessage(role, content, sources, timeMs, tipo, queryExecuted, queryResults, messageId, tableData) {
            sources = sources || [];
            timeMs = timeMs || 0;
            const div = document.createElement('div');
            div.className = 'message';

            const now = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const name = role === 'user' ? (currentUser || 'Voce') : 'MMarra AI';
            const avatarClass = role;
            const avatarContent = role === 'user'
                ? (currentUser ? currentUser.charAt(0).toUpperCase() : 'U')
                : '<img src="imagens/logo.png" alt="MM">';

            // Badge de tipo
            let tipoBadge = '';
            if (role === 'assistant' && tipo) {
                const tipoLabels = {
                    'consulta_banco': ' SQL',
                    'documentacao': ' DOC',
                    'conhecimento': ' CONHECIMENTO',
                    'arquivo': ' ARQUIVO',
                    'info': ' INFO',
                    'erro': ' ERRO',
                };
                const tipoLabel = tipoLabels[tipo] || tipo.toUpperCase();
                tipoBadge = '<span class="tipo-badge ' + tipo + '">' + tipoLabel + '</span>';
            }

            let html = '<div class="message-header">' +
                '<div class="message-avatar ' + avatarClass + '">' + avatarContent + '</div>' +
                '<span class="message-name">' + name + '</span>' +
                tipoBadge +
                '<span class="message-time">' + now + '</span>' +
                '</div>' +
                '<div class="message-body">' + (role === 'user' ? escapeHtml(content) : renderMarkdown(content)) + '</div>';

            if (sources && sources.length > 0) {
                html += '<div class="sources">' + sources.map(function(s) {
                    return '<span class="source-tag">F ' + s.path.split('/').pop() + ' (' + s.score + ')</span>';
                }).join('') + '</div>';
            }

            // Query executada (colapsavel)
            if (role === 'assistant' && queryExecuted) {
                const queryId = 'query-' + Date.now();
                html += '<div class="query-info">' +
                    '<button class="query-toggle" onclick="toggleQuery(\'' + queryId + '\', this)">' +
                    '<span class="query-toggle-icon">&gt;</span> ' +
                    'Query executada (' + (queryResults || 0) + ' registros)' +
                    '</button>' +
                    '<div class="query-content" id="' + queryId + '">' +
                    '<pre>' + escapeHtml(queryExecuted) + '</pre>' +
                    '<div class="query-stats">' + (queryResults || 0) + ' registros retornados | ' + timeMs + 'ms</div>' +
                    '</div></div>';
            }

            if (role === 'assistant' && timeMs > 0 && !queryExecuted) {
                html += '<div class="response-meta">' + timeMs + 'ms</div>';
            }

            // Feedback buttons (only for assistant messages with message_id)
            if (role === 'assistant' && messageId) {
                const fbId = 'fb-' + messageId.substring(0, 8);
                html += '<div class="feedback-bar" id="' + fbId + '">' +
                    '<button class="feedback-btn positive" onclick="sendFeedback(\'' + messageId + '\', \'positive\', \'' + fbId + '\')" title="Resposta util">&#128077;</button>' +
                    '<button class="feedback-btn negative" onclick="sendFeedback(\'' + messageId + '\', \'negative\', \'' + fbId + '\')" title="Resposta incorreta">&#128078;</button>' +
                    '</div>' +
                    '<div class="feedback-comment" id="' + fbId + '-comment">' +
                    '<input type="text" placeholder="O que estava errado?" maxlength="200" onkeydown="if(event.key===\'Enter\')submitComment(\'' + messageId + '\', \'' + fbId + '\')">' +
                    '<button onclick="submitComment(\'' + messageId + '\', \'' + fbId + '\')">Enviar</button>' +
                    '</div>';
            }

            div.innerHTML = html;
            messagesEl.appendChild(div);

            // Renderizar toggle de colunas se houver table_data
            if (role === 'assistant' && tableData && tableData.rows && tableData.rows.length > 0) {
                setTimeout(function() { renderColumnToggles(div, tableData); }, 50);
            }

            scrollToBottom();
        }

        function toggleQuery(id, btn) {
            const content = document.getElementById(id);
            content.classList.toggle('visible');
            btn.classList.toggle('expanded');
        }

        // ===== FEEDBACK =====
        async function sendFeedback(messageId, rating, fbId) {
            const bar = document.getElementById(fbId);
            if (!bar) return;

            const btns = bar.querySelectorAll('.feedback-btn');
            btns.forEach(function(btn) {
                if (btn.classList.contains(rating)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.add('hidden');
                }
            });

            // Se negativo, mostrar campo de comentario
            if (rating === 'negative') {
                const commentDiv = document.getElementById(fbId + '-comment');
                if (commentDiv) {
                    commentDiv.classList.add('visible');
                    const inp = commentDiv.querySelector('input');
                    if (inp) inp.focus();
                }
            } else {
                // Positivo: mostrar agradecimento
                const thanks = document.createElement('span');
                thanks.className = 'feedback-thanks';
                thanks.textContent = 'Obrigado!';
                bar.appendChild(thanks);
            }

            // Enviar para API
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ message_id: messageId, rating: rating }),
                });
            } catch (e) {
                console.error('Erro ao enviar feedback:', e);
            }
        }

        async function submitComment(messageId, fbId) {
            const commentDiv = document.getElementById(fbId + '-comment');
            if (!commentDiv) return;
            const inp = commentDiv.querySelector('input');
            const comment = (inp ? inp.value.trim() : '') || null;

            // Enviar com comentario
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ message_id: messageId, rating: 'negative', comment: comment }),
                });
            } catch (e) {
                console.error('Erro ao enviar comentario:', e);
            }

            // Substituir campo por agradecimento
            commentDiv.classList.remove('visible');
            const bar = document.getElementById(fbId);
            if (bar) {
                const thanks = document.createElement('span');
                thanks.className = 'feedback-thanks';
                thanks.textContent = comment ? 'Obrigado pelo feedback!' : 'Obrigado!';
                bar.appendChild(thanks);
            }
        }

        function addThinking() {
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message';
            div.id = id;
            div.innerHTML = '<div class="message-header">' +
                '<div class="message-avatar assistant"><img src="imagens/logo.png" alt="MM"></div>' +
                '<span class="message-name">MMarra AI</span>' +
                '</div>' +
                '<div class="thinking">' +
                '<div class="thinking-dots"><span></span><span></span><span></span></div>' +
                ' Pensando...' +
                '</div>';
            messagesEl.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // ===== MARKDOWN RENDERER =====
        function renderMarkdown(text) {
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
                return '<pre><code>' + escapeHtml(code.trim()) + '</code></pre>';
            });
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Links: [texto](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(_, linkText, url) {
                // Se for link de download (exports), adicionar classe especial
                if (url.includes('/exports/')) {
                    return '<a href="' + url + '" class="download-link" download target="_blank"> ' + linkText + '</a>';
                }
                return '<a href="' + url + '" target="_blank">' + linkText + '</a>';
            });

            text = text.replace(/(\|.+\|)\n(\|[-|: ]+\|)\n((?:\|.+\|\n?)*)/g, function(_, header, sep, body) {
                var headers = header.split('|').filter(function(c) { return c.trim(); }).map(function(c) { return '<th>' + c.trim() + '</th>'; }).join('');
                var rows = body.trim().split('\n').map(function(row) {
                    var cells = row.split('|').filter(function(c) { return c.trim(); }).map(function(c) { return '<td>' + c.trim() + '</td>'; }).join('');
                    return '<tr>' + cells + '</tr>';
                }).join('');
                return '<table><thead><tr>' + headers + '</tr></thead><tbody>' + rows + '</tbody></table>';
            });

            text = text.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
            text = text.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            text = text.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            text = text.replace(/\n\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            text = text.replace(/<p><(h[123]|pre|ul|ol|table|blockquote)/g, '<$1');
            text = text.replace(/<\/(h[123]|pre|ul|ol|table|blockquote)><\/p>/g, '</$1>');
            text = text.replace(/<p><\/p>/g, '');

            return text;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ===== COLUMN TOGGLE =====
        var TOGGLEABLE_COLUMNS = {
            'NUM_FABRICANTE': 'Cod. Fabricante',
            'NUM_ORIGINAL':   'Nro. Original',
            'REFERENCIA':     'Referencia',
            'REF_FORNECEDOR': 'Ref. Forn.',
            'COMPLEMENTO':    'Complemento',
            'NCM':            'NCM',
            'GRUPO_PRODUTO':  'Grupo',
            'ESTOQUE':        'Estoque',
            'APLICACAO':      'Aplicacao',
            'VLR_UNITARIO':   'Vlr Unit.',
            'QTD_PEDIDA':     'Qtd Pedida',
            'QTD_ATENDIDA':   'Qtd Atend.',
            'CONFIRMADO':     'Confirmado',
            'DT_PEDIDO':      'Data Pedido',
            'PREVISAO_ENTREGA': 'Previsao',
            'EMPRESA':        'Empresa',
            'COMPRADOR':      'Comprador',
            'TIPO_COMPRA':    'Tipo',
        };
        var COLUMN_LABELS = {
            'PEDIDO': 'Pedido', 'CODPROD': 'CodProd', 'PRODUTO': 'Produto',
            'MARCA': 'Marca', 'QTD_PENDENTE': 'Qtd Pend.', 'VLR_PENDENTE': 'Valor',
            'STATUS_ENTREGA': 'Status', 'FORNECEDOR': 'Fornecedor',
            'DT_PEDIDO': 'Data', 'PREVISAO_ENTREGA': 'Previsao',
            'EMPRESA': 'Empresa', 'TIPO_COMPRA': 'Tipo', 'COMPRADOR': 'Comprador',
            'CONFIRMADO': 'Confirmado', 'APLICACAO': 'Aplicacao',
            'UNIDADE': 'Unid.', 'QTD_PEDIDA': 'Qtd Pedida', 'QTD_ATENDIDA': 'Qtd Atend.',
            'VLR_UNITARIO': 'Vlr Unit.', 'DIAS_ABERTO': 'Dias',
            'NUM_FABRICANTE': 'Cod. Fabricante', 'NUM_ORIGINAL': 'Nro. Original',
            'REFERENCIA': 'Referencia', 'REF_FORNECEDOR': 'Ref. Forn.',
            'COMPLEMENTO': 'Complemento', 'NCM': 'NCM',
            'GRUPO_PRODUTO': 'Grupo', 'ESTOQUE': 'Estoque',
            '_itens': 'Itens', '_valor': 'Valor Pendente',
        };

        function renderColumnToggles(msgDiv, tableData) {
            if (!tableData || !tableData.rows || tableData.rows.length === 0) return;

            var body = msgDiv.querySelector('.message-body');
            if (!body) return;

            // Colunas visiveis atualmente na tabela markdown
            var currentTable = body.querySelector('table');
            if (!currentTable) return;

            var currentCols = [];
            var ths = currentTable.querySelectorAll('thead th');
            ths.forEach(function(th) { currentCols.push(th.textContent.trim()); });

            // Determinar colunas toggleaveis que existem nos dados
            var availableToggles = [];
            var allDataCols = tableData.columns || Object.keys(tableData.rows[0] || {});
            var activeCols = (tableData.visible_columns || []).slice();

            for (var key in TOGGLEABLE_COLUMNS) {
                if (allDataCols.indexOf(key) !== -1) {
                    var label = TOGGLEABLE_COLUMNS[key];
                    var isActive = activeCols.indexOf(key) !== -1;
                    // Verificar se ja esta na tabela atual
                    var inTable = currentCols.indexOf(label) !== -1 || currentCols.indexOf(key) !== -1;
                    availableToggles.push({ key: key, label: label, active: isActive || inTable });
                }
            }

            if (availableToggles.length === 0) return;

            // Criar container de toggles
            var container = document.createElement('div');
            container.className = 'column-toggles';
            container.innerHTML = '<span class="label">Colunas:</span>';

            // Guardar dados no elemento
            msgDiv._tableData = tableData;
            msgDiv._activeCols = availableToggles.filter(function(t) { return t.active; }).map(function(t) { return t.key; });

            availableToggles.forEach(function(toggle) {
                var chip = document.createElement('span');
                chip.className = 'col-chip' + (toggle.active ? ' active' : '');
                chip.textContent = toggle.label;
                chip.dataset.col = toggle.key;
                chip.onclick = function() {
                    chip.classList.toggle('active');
                    var idx = msgDiv._activeCols.indexOf(toggle.key);
                    if (idx === -1) {
                        msgDiv._activeCols.push(toggle.key);
                    } else {
                        msgDiv._activeCols.splice(idx, 1);
                    }
                    rerenderTable(msgDiv);
                };
                container.appendChild(chip);
            });

            // Inserir antes do feedback-bar ou no final do body
            var feedbackBar = msgDiv.querySelector('.feedback-bar');
            if (feedbackBar) {
                msgDiv.insertBefore(container, feedbackBar);
            } else {
                body.parentNode.insertBefore(container, body.nextSibling);
            }
        }

        function rerenderTable(msgDiv) {
            var td = msgDiv._tableData;
            if (!td || !td.rows || td.rows.length === 0) return;

            var body = msgDiv.querySelector('.message-body');
            if (!body) return;

            var oldTable = body.querySelector('table');
            if (!oldTable) return;

            var activeCols = msgDiv._activeCols || [];
            var rows = td.rows;

            // Colunas base (sempre visiveis na tabela original)
            var baseCols = ['PEDIDO', 'CODPROD', 'PRODUTO', 'MARCA', 'FORNECEDOR'];
            var numCols = ['QTD_PENDENTE', 'VLR_PENDENTE', 'STATUS_ENTREGA', 'DIAS_ABERTO'];

            // Construir colunas finais: base + extras ativas + numericas
            var finalCols = [];
            baseCols.forEach(function(c) {
                if (rows[0].hasOwnProperty(c)) finalCols.push(c);
            });
            activeCols.forEach(function(c) {
                if (finalCols.indexOf(c) === -1 && rows[0].hasOwnProperty(c)) finalCols.push(c);
            });
            numCols.forEach(function(c) {
                if (finalCols.indexOf(c) === -1 && rows[0].hasOwnProperty(c)) finalCols.push(c);
            });

            // Construir nova tabela HTML
            var html = '<table><thead><tr>';
            finalCols.forEach(function(c) {
                html += '<th>' + (COLUMN_LABELS[c] || c) + '</th>';
            });
            html += '</tr></thead><tbody>';

            var maxRows = Math.min(rows.length, 50);
            for (var i = 0; i < maxRows; i++) {
                html += '<tr>';
                finalCols.forEach(function(c) {
                    var val = rows[i][c];
                    if (val === null || val === undefined) val = '';
                    // Formatar valores numericos
                    if (c === 'VLR_PENDENTE' || c === 'VLR_UNITARIO') {
                        var num = parseFloat(val);
                        if (!isNaN(num)) val = 'R$ ' + num.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    } else if (c === 'QTD_PENDENTE' || c === 'QTD_PEDIDA' || c === 'QTD_ATENDIDA' || c === 'ESTOQUE') {
                        var n = parseInt(val);
                        if (!isNaN(n)) val = n.toLocaleString('pt-BR');
                    }
                    // Truncar textos longos
                    var s = String(val);
                    if (s.length > 30 && (c === 'PRODUTO' || c === 'FORNECEDOR' || c === 'COMPLEMENTO' || c === 'APLICACAO')) {
                        s = s.substring(0, 28) + '...';
                    }
                    html += '<td>' + escapeHtml(s) + '</td>';
                });
                html += '</tr>';
            }
            if (rows.length > maxRows) {
                html += '<tr><td colspan="' + finalCols.length + '" style="text-align:center;color:var(--text-muted);font-style:italic;">... e mais ' + (rows.length - maxRows) + ' registros</td></tr>';
            }
            html += '</tbody></table>';

            oldTable.outerHTML = html;
            scrollToBottom();
        }

        // ===== UTILS =====
        function scrollToBottom() {
            requestAnimationFrame(function() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        async function clearChat() {
            if (!confirm('Limpar conversa?')) return;
            try {
                await fetch('/api/clear', {
                    method: 'POST',
                    headers: authHeaders()
                });
            } catch {}
            messagesEl.innerHTML = '';
            messagesEl.style.display = 'none';
            welcomeEl.style.display = 'flex';
            document.getElementById('stat-history').textContent = '0';
        }

        // ============================================================
        // REPORTS MODULE (Cross-filter + Cache)
        // ============================================================

        let currentReportId = null;
        let currentReportData = null;  // dados originais do backend
        let crossFilterKey = null;     // campo sendo filtrado (ex: "FORNECEDOR")
        let crossFilterValue = null;   // valor selecionado (ex: "Filtros Mann S.A.")

        function openReport(reportId) {
            currentReportId = reportId;
            crossFilterKey = null;
            crossFilterValue = null;
            document.getElementById('reports-list').style.display = 'none';
            document.getElementById('report-view').classList.add('active');
            document.getElementById('report-content').style.display = 'none';
            document.getElementById('report-loading').style.display = 'flex';
            document.getElementById('report-time').textContent = '';
            document.getElementById('report-cross-filter').classList.remove('active');

            // Reset filters
            document.getElementById('filter-data-ini').value = '';
            document.getElementById('filter-data-fim').value = '';

            // Hide date filters for estoque_critico
            const filtersEl = document.getElementById('report-filters');
            if (reportId === 'estoque_critico') {
                filtersEl.style.display = 'none';
            } else {
                filtersEl.style.display = 'flex';
            }

            fetchReport(reportId, {});
        }

        function closeReport() {
            currentReportId = null;
            currentReportData = null;
            crossFilterKey = null;
            crossFilterValue = null;
            document.getElementById('report-view').classList.remove('active');
            document.getElementById('reports-list').style.display = 'block';
        }

        function applyReportFilters() {
            if (!currentReportId) return;

            const params = collectCurrentFilters();

            // Preservar categoria ativa se existir
            const activeCat = document.querySelector('.report-cat-tab.active');
            if (activeCat) {
                const catId = activeCat.querySelector('.cat-nome')?.textContent;
                // Mapear nome de volta pra ID
                const catMap = {
                    'Pedidos em Aberto': 'todos',
                    'Atrasados': 'atrasados',
                    'Prximo (7 dias)': 'proximo',
                    'Sem Previso': 'sem_previsao',
                    'No Prazo': 'no_prazo',
                    'Trnsito': 'transito',
                };
                for (const [nome, id] of Object.entries(catMap)) {
                    if (catId && catId.includes(nome.substring(0, 8))) {
                        params.categoria = id;
                        break;
                    }
                }
            }

            // Limpar cross-filter
            crossFilterKey = null;
            crossFilterValue = null;
            document.getElementById('report-cross-filter').classList.remove('active');

            document.getElementById('report-content').style.display = 'none';
            document.getElementById('report-loading').style.display = 'flex';
            fetchReport(currentReportId, params);
        }

        async function fetchReport(reportId, params) {
            try {
                const res = await fetch(`/api/reports/${reportId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders()
                    },
                    body: JSON.stringify(params),
                });

                if (res.status === 401) {
                    doLogout();
                    return;
                }

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Erro ao carregar relatorio');
                }

                const data = await res.json();
                currentReportData = data;
                renderReport(data);

            } catch (e) {
                document.getElementById('report-loading').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';
                document.getElementById('report-kpis').innerHTML =
                    `<div style="grid-column:1/-1;text-align:center;color:var(--error);padding:40px;">[X] ${e.message}</div>`;
                document.getElementById('report-chart').innerHTML = '';
                document.getElementById('report-table-head').innerHTML = '';
                document.getElementById('report-table-body').innerHTML = '';
            }
        }

        function renderReport(data, filteredTableData, filteredKpis) {
            document.getElementById('report-loading').style.display = 'none';
            document.getElementById('report-content').style.display = 'block';

            // Title + time + cache badge
            document.getElementById('report-view-title').textContent = data.nome || 'Relatorio';
            let timeText = `${data.time_ms}ms`;
            if (data.from_cache) timeText += ' (cache)';
            document.getElementById('report-time').textContent = timeText;

            // Dados a exibir (originais ou filtrados)
            const tableData = filteredTableData || data.table_data || [];
            const kpis = filteredKpis || data.kpis || [];

            // ========== CATEGORIAS (6 abas como Power BI) ==========
            const catsEl = document.getElementById('report-categorias');
            catsEl.innerHTML = '';
            if (data.categorias && data.categorias.length > 0) {
                catsEl.style.display = 'flex';
                const activeCat = (data.filtros_aplicados || {}).categoria || 'todos';
                data.categorias.forEach(cat => {
                    const isActive = cat.id === activeCat;
                    catsEl.innerHTML += `
                        <div class="report-cat-tab${isActive ? ' active' : ''}" onclick="filterByCategory('${cat.id}')">
                            <div class="cat-nome">${cat.nome}</div>
                            <div class="cat-valor">${cat.valor_fmt || formatBRL(cat.valor_total)}</div>
                            <div class="cat-detalhe">Pedidos: ${cat.qtd_pedidos} &middot; Produtos: ${cat.qtd_produtos}</div>
                        </div>`;
                });
            } else {
                catsEl.style.display = 'none';
            }

            // ========== DROPDOWN FILTERS ==========
            if (data.filtros_disponiveis && !filteredTableData) {
                populateDropdownFilters(data.filtros_disponiveis);
            }

            // ========== KPIs ==========
            const kpisEl = document.getElementById('report-kpis');
            kpisEl.innerHTML = '';
            kpis.forEach(kpi => {
                const alertClass = kpi.alert ? ' alert' : '';
                kpisEl.innerHTML += `
                    <div class="report-kpi-card${alertClass}">
                        <div class="report-kpi-icon">${kpi.icon || ''}</div>
                        <div class="report-kpi-value">${kpi.value}</div>
                        <div class="report-kpi-label">${kpi.label}</div>
                    </div>`;
            });

            // ========== TABLE ==========
            renderTable(data.table_columns, tableData);
            document.getElementById('report-row-count').textContent =
                `${tableData.length} registro${tableData.length !== 1 ? 's' : ''}`;

            // ========== CHARTS ==========
            // Multi-chart grid (4 graficos como Power BI)
            if (data.charts && data.charts.length > 0) {
                renderHBarCharts(data.charts);
                document.getElementById('report-chart').style.display = 'none';
            }
            // Single chart fallback (vendas, estoque)
            else if (data.chart_data && data.chart_data.labels) {
                document.getElementById('report-charts-grid').innerHTML = '';
                renderChart(data.chart_data);
            }
        }

        // ==========================================================
        // CATEGORY TABS (Power BI navigation)
        // ==========================================================

        function filterByCategory(catId) {
            if (!currentReportId) return;

            // Coletar filtros atuais dos dropdowns
            const params = collectCurrentFilters();
            params.categoria = catId;

            // Limpar cross-filter
            crossFilterKey = null;
            crossFilterValue = null;
            document.getElementById('report-cross-filter').classList.remove('active');

            document.getElementById('report-content').style.display = 'none';
            document.getElementById('report-loading').style.display = 'flex';
            fetchReport(currentReportId, params);
        }

        function collectCurrentFilters() {
            const params = {};
            const dataIni = document.getElementById('filter-data-ini').value;
            const dataFim = document.getElementById('filter-data-fim').value;
            if (dataIni) params.data_ini = new Date(dataIni).toLocaleDateString('pt-BR');
            if (dataFim) params.data_fim = new Date(dataFim).toLocaleDateString('pt-BR');

            const emp = document.getElementById('filter-empresa').value;
            if (emp) params.codemp = parseInt(emp);
            const comp = document.getElementById('filter-comprador').value;
            if (comp) params.codvend = parseInt(comp);
            const marca = document.getElementById('filter-marca').value;
            if (marca) params.codmarca = parseInt(marca);

            return params;
        }

        function populateDropdownFilters(filtros) {
            // Empresa
            const empSel = document.getElementById('filter-empresa');
            const empVal = empSel.value;
            empSel.innerHTML = '<option value="">Todos</option>';
            (filtros.empresas || []).forEach(opt => {
                empSel.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
            empSel.value = empVal;

            // Comprador
            const compSel = document.getElementById('filter-comprador');
            const compVal = compSel.value;
            compSel.innerHTML = '<option value="">Todos</option>';
            (filtros.compradores || []).forEach(opt => {
                compSel.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
            compSel.value = compVal;

            // Marca
            const marcaSel = document.getElementById('filter-marca');
            const marcaVal = marcaSel.value;
            marcaSel.innerHTML = '<option value="">Todos</option>';
            (filtros.marcas || []).forEach(opt => {
                marcaSel.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
            marcaSel.value = marcaVal;
        }

        // ==========================================================
        // HORIZONTAL BAR CHARTS (4 graficos como Power BI)
        // ==========================================================

        function renderHBarCharts(charts) {
            const grid = document.getElementById('report-charts-grid');
            grid.innerHTML = '';
            if (!charts || charts.length === 0) return;

            charts.forEach((chart, chartIdx) => {
                if (!chart.labels || chart.labels.length === 0) return;

                const maxVal = Math.max(...chart.values, 1);
                let rowsHtml = '';

                chart.labels.forEach((label, i) => {
                    const val = chart.values[i] || 0;
                    const pct = Math.round((val / maxVal) * 100);
                    const valFmt = val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    const dimmed = crossFilterValue && crossFilterKey === chart.filter_key && label !== crossFilterValue ? ' dimmed' : '';
                    const highlight = crossFilterValue && crossFilterKey === chart.filter_key && label === crossFilterValue ? ' style="font-weight:700"' : '';

                    rowsHtml += `
                        <div class="hbar-row${dimmed}" onclick="applyChartCrossFilter('${chart.filter_key}', '${label.replace(/'/g, "\\'")}', ${chartIdx})"${highlight}>
                            <span class="hbar-label" title="${label}">${label}</span>
                            <div class="hbar-bar-container">
                                <div class="hbar-bar" style="width:${pct}%"></div>
                            </div>
                            <span class="hbar-value">${valFmt}</span>
                        </div>`;
                });

                grid.innerHTML += `
                    <div class="report-chart-card">
                        <div class="chart-title">${chart.title || ''}</div>
                        <div class="hbar-chart">${rowsHtml}</div>
                    </div>`;
            });
        }

        function applyChartCrossFilter(filterKey, label, chartIdx) {
            if (!currentReportData) return;

            // Toggle: se clicar no mesmo, limpa
            if (crossFilterKey === filterKey && crossFilterValue === label) {
                clearCrossFilter();
                return;
            }

            crossFilterKey = filterKey;
            crossFilterValue = label;

            // Mostrar indicador
            document.getElementById('cross-filter-value').textContent = `${filterKey}: ${label}`;
            document.getElementById('report-cross-filter').classList.add('active');

            // Filtrar tabela
            const allRows = currentReportData.table_data || [];
            const filtered = allRows.filter(row => {
                for (const [key, val] of Object.entries(row)) {
                    if (key.toUpperCase() === filterKey.toUpperCase()) {
                        const rowVal = String(val).toUpperCase();
                        const filterVal = String(label).toUpperCase();
                        if (rowVal === filterVal || rowVal.startsWith(filterVal) || rowVal.includes(filterVal)) {
                            return true;
                        }
                    }
                }
                return false;
            });

            const newKpis = recalcKpis(currentReportData.report_id, filtered);
            renderReport(currentReportData, filtered, newKpis);
        }

        // ==========================================================
        // CROSS-FILTER LOGIC
        // ==========================================================

        function applyCrossFilter(label) {
            if (!currentReportData) return;

            const chartData = currentReportData.chart_data || {};
            const filterKey = chartData.filter_key; // ex: "FORNECEDOR", "MARCA", "DATA"
            if (!filterKey) return;

            // Se clicar no mesmo filtro, limpa
            if (crossFilterValue === label) {
                clearCrossFilter();
                return;
            }

            crossFilterKey = filterKey;
            crossFilterValue = label;

            // Mostrar indicador de filtro
            document.getElementById('cross-filter-value').textContent = `${filterKey}: ${label}`;
            document.getElementById('report-cross-filter').classList.add('active');

            // Filtrar tabela
            const allRows = currentReportData.table_data || [];
            const filtered = allRows.filter(row => {
                // Procurar o campo correspondente no row (case-insensitive match)
                for (const [key, val] of Object.entries(row)) {
                    if (key.toUpperCase() === filterKey.toUpperCase()) {
                        // Match parcial: "Filtros Mann" match "Filtros Mann S.A."
                        const rowVal = String(val).toUpperCase();
                        const filterVal = String(label).toUpperCase();
                        if (rowVal === filterVal || rowVal.startsWith(filterVal) || rowVal.includes(filterVal)) {
                            return true;
                        }
                    }
                }
                return false;
            });

            // Recalcular KPIs com dados filtrados
            const newKpis = recalcKpis(currentReportData.report_id, filtered);

            // Re-render com filtro
            renderReport(currentReportData, filtered, newKpis);
        }

        function clearCrossFilter() {
            crossFilterKey = null;
            crossFilterValue = null;
            document.getElementById('report-cross-filter').classList.remove('active');

            // Re-render com dados originais
            if (currentReportData) {
                renderReport(currentReportData);
            }
        }

        function recalcKpis(reportId, filteredRows) {
            /**
             * Recalcula KPIs baseado nos dados filtrados.
             * Cada relatorio tem sua logica propria.
             */
            if (reportId === 'pendencia_compras') {
                // Contar pedidos distintos
                const pedidos = new Set(filteredRows.map(r => r.PEDIDO)).size;
                const qtdProd = filteredRows.length;
                const vlrTotal = filteredRows.reduce((s, r) => s + (parseFloat(r.VLR_TOTAL_PENDENTE) || 0), 0);

                return [
                    { label: "Valor Total Pendente", value: formatBRL(vlrTotal), icon: "" },
                    { label: "Pedidos", value: String(pedidos), icon: "" },
                    { label: "Itens", value: String(qtdProd), icon: "" },
                ];
            }

            if (reportId === 'vendas_periodo') {
                const qtd = filteredRows.reduce((s, r) => s + (parseInt(r.QTD_VENDAS) || 0), 0);
                const fat = filteredRows.reduce((s, r) => s + (parseFloat(r.FATURAMENTO) || 0), 0);
                const ticket = qtd > 0 ? fat / qtd : 0;

                return [
                    { label: "Notas de Venda", value: String(qtd), icon: "" },
                    { label: "Faturamento", value: formatBRL(fat), icon: "" },
                    { label: "Ticket Mdio", value: formatBRL(ticket), icon: "" },
                    { label: "Registros", value: `${filteredRows.length} dias`, icon: "" },
                ];
            }

            if (reportId === 'estoque_critico') {
                const qtd = filteredRows.length;
                const zerados = filteredRows.filter(r => parseInt(r.ESTOQUE_ATUAL) === 0).length;
                // Sem campo de valor na tabela, mantemos placeholder
                return [
                    { label: "Produtos Crticos", value: String(qtd), icon: "", alert: true },
                    { label: "Estoque Zerado", value: String(zerados), icon: "", alert: zerados > 0 },
                    { label: "Itens Filtrados", value: String(qtd), icon: "" },
                ];
            }

            // Fallback: retorna KPIs originais
            return currentReportData.kpis || [];
        }

        function formatBRL(value) {
            return `R$ ${Number(value).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // ==========================================================
        // CHART RENDERING (Plotly.js com cross-filter click)
        // ==========================================================

        function renderChart(chartData) {
            const chartEl = document.getElementById('report-chart');
            if (!chartData || !chartData.labels || chartData.labels.length === 0) {
                chartEl.style.display = 'none';
                return;
            }
            chartEl.style.display = 'block';

            const trace = {
                x: chartData.labels,
                y: chartData.values,
                type: chartData.type || 'bar',
                hovertemplate: '%{x}<br>%{y:,.0f}<extra></extra>',
            };

            if (chartData.type === 'bar') {
                // Cores: barra selecionada fica highlight, outras ficam opacas
                trace.marker = {
                    color: chartData.labels.map((label, i) => {
                        if (crossFilterValue && label !== crossFilterValue) {
                            return 'rgba(14, 117, 185, 0.2)'; // opaca
                        }
                        if (crossFilterValue && label === crossFilterValue) {
                            return 'rgba(26, 143, 216, 1)'; // highlight
                        }
                        // Sem filtro: gradiente
                        const opacity = Math.max(1 - (i * 0.06), 0.4);
                        return `rgba(14, 117, 185, ${opacity})`;
                    }),
                    borderRadius: 4,
                };
            } else {
                trace.line = { color: '#0e75b9', width: 2.5 };
                trace.fill = 'tozeroy';
                trace.fillcolor = 'rgba(14, 117, 185, 0.06)';
                trace.marker = {
                    color: chartData.labels.map(label => {
                        if (crossFilterValue && label !== crossFilterValue) return 'rgba(14, 117, 185, 0.3)';
                        if (crossFilterValue && label === crossFilterValue) return '#1a8fd8';
                        return '#0e75b9';
                    }),
                    size: chartData.labels.map(label => {
                        return (crossFilterValue && label === crossFilterValue) ? 10 : 5;
                    }),
                };
            }

            const layout = {
                title: { text: chartData.title || '', font: { color: '#e8e6e3', size: 14, family: 'DM Sans' } },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#9a9898', family: 'DM Sans', size: 11 },
                margin: { t: 40, r: 20, b: 60, l: 70 },
                xaxis: {
                    gridcolor: '#2a2a30',
                    tickangle: chartData.labels.length > 6 ? -30 : 0,
                },
                yaxis: {
                    gridcolor: '#2a2a30',
                    tickformat: ',.0f',
                },
                bargap: 0.3,
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot(chartEl, [trace], layout, config);

            // Registrar click handler para cross-filter
            chartEl.removeAllListeners && chartEl.removeAllListeners('plotly_click');
            chartEl.on('plotly_click', function(eventData) {
                if (eventData.points && eventData.points.length > 0) {
                    const label = eventData.points[0].x;
                    applyCrossFilter(label);
                }
            });
        }

        // ==========================================================
        // TABLE RENDERING
        // ==========================================================

        function renderTable(columns, data) {
            const thead = document.getElementById('report-table-head');
            const tbody = document.getElementById('report-table-body');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (!columns || columns.length === 0) return;

            // Header
            let headerRow = '<tr>';
            columns.forEach(col => {
                const align = (col.type === 'currency' || col.type === 'number') ? ' style="text-align:right"' : '';
                headerRow += `<th${align}>${col.label}</th>`;
            });
            headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // Body
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length}" style="text-align:center;padding:30px;color:var(--text-muted);">Nenhum registro encontrado</td></tr>`;
                return;
            }

            let html = '';
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let val = row[col.key];
                    if (val === null || val === undefined) val = '-';

                    if (col.type === 'currency') {
                        const num = parseFloat(val) || 0;
                        val = formatBRL(num);
                        html += `<td class="currency">${val}</td>`;
                    } else if (col.type === 'number') {
                        html += `<td class="number">${val}</td>`;
                    } else {
                        html += `<td>${val}</td>`;
                    }
                });
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }

        // ==========================================================
        // CSV EXPORT
        // ==========================================================

        function exportReportCSV() {
            if (!currentReportData || !currentReportData.table_data) return;

            const columns = currentReportData.table_columns || [];
            // Exportar dados filtrados se cross-filter ativo
            let data = currentReportData.table_data || [];
            if (crossFilterKey && crossFilterValue) {
                data = data.filter(row => {
                    for (const [key, val] of Object.entries(row)) {
                        if (key.toUpperCase() === crossFilterKey.toUpperCase()) {
                            const rowVal = String(val).toUpperCase();
                            const filterVal = String(crossFilterValue).toUpperCase();
                            if (rowVal.includes(filterVal)) return true;
                        }
                    }
                    return false;
                });
            }

            let csv = columns.map(c => c.label).join(';') + '\n';
            data.forEach(row => {
                const line = columns.map(col => {
                    let val = row[col.key];
                    if (val === null || val === undefined) return '';
                    val = String(val).replace(/;/g, ',');
                    return val;
                }).join(';');
                csv += line + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const suffix = crossFilterValue ? `_${crossFilterValue.replace(/[^a-zA-Z0-9]/g, '_')}` : '';
            a.download = `${currentReportData.report_id || 'relatorio'}${suffix}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== STARTUP =====
        checkSession();
    </script>
</body>
</html>
